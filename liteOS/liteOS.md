*************《华为物联网操作系统LiteOS》 **************

 

\--------------------------------------------------------

本课程由朱有鹏物联网大讲堂录制并拥有完整版权，翻录必究

配套图书由人民邮电出版社出版，华为云IoT官方授权合作支持

\--------------------------------------------------------

# 第一部分、章节目录

1.课程介绍和书目分析

2.物联网的概念

3.物联网的发展历程

4.物联网的典型案例

5.物联网的分支应用领域

6.究竟该如何理解物联网

7.物联网的技术实现架构

8.物联网各层次涉及的核心技术1

9.物联网各层次涉及的核心技术2

10.华为的物联网解决方案介绍

11.华为认证和NBIOT芯片介绍

12.一节课说清楚什么是操作系统

13.操作系统的技术组成和哲学原理

14.如何定义物联网操作系统IoTOS

15.主流IoTOS介绍和LiteOS的优势分析

  

 

# 第二部分、章节介绍

**1.****课程介绍和书目分析**

  本节介绍整个课程的规划和对应的图书目录结构安排。

**2.****物联网的概念**

  本节由百度百科和维基百科的定义出发结合我们自己的总结讲解物联网的概念。

**3.****物联网的发展历程**

  本节讲述物联网的发展历程和演进变化，论证本轮物联网革命并非泡沫。

**4.****物联网的典型案例**

  本节讲解三个典型的物联网案例，让大家通过案例来体会物联网的真正用法和价值。

**5.****物联网的分支应用领域**

  本节讲述物联网的部分主流的分支应用领域，这也是目前物联网快速发展的行业。

**6.****究竟该如何理解物联网**

  本节结合之前的讲解，总结物联网的概念和含义，给出我们对物联网的论断。

**7.****物联网的技术实现架构**

  本节讲解物联网的云管端模型和4层架构，从技术角度解析物联网系统的构成。

**8.****物联网各层次涉及的核心技术****1**

  本节讲解物联网传感层和网络层所涉及到的核心技术。

**9.****物联网各层次涉及的核心技术****2**

  本节讲解物联网平台层和应用层所涉及到的核心技术。

**10.****华为的物联网解决方案介绍**

  本节全面介绍华为的物联网解决方案，重点是华为云IoT。

**11.****华为认证和****NBIOT****芯片介绍**

  本节介绍华为认证体系，尤其是华为物联网认证和华为的NBIOT芯片。

**12.****一节课说清楚什么是操作系统**

  本节用半小时举例类比的方式讲解什么是操作系统。

**13.****操作系统的技术组成和哲学原理**

  本节从技术构成上解析操作系统的组成部分和设计哲学。

**14.****如何定义物联网操作系统****IoTOS**

  本节引入IoTOS的概念并重点对比讲解了RTOS和IoTOS的关联和异同。

**15.****主流****IoTOS****介绍和****LiteOS****的优势分析**

  本节介绍主流的IoTOS，并且讲解了华为LiteOS的优势，尤其是华为云IoT产品认证服务。

 

  

  

 

# 第三部分、随堂记录

## 1.课程介绍和书目分析

### 1.1、本课程介绍

(1)本课程主要围绕华为物联网操作系统LiteOS来讲，适合对物联网开发感兴趣的同学。

(2)本课程不要求前置技术能力，但是有MCU、C语言、RTOS等技能经验的人可以学到更多。

### 1.2、为什么会有本课程

(1)让嵌入式开发者系统学习LiteOS，以便基于LiteOS开发IoT产品。

(2)让嵌入式开发者了解IoTOS下的典型IoT设备开发，提升个人开发技能和理念。

(3)让对IoT和IoTOS感兴趣的人更专业全面的理解IoT和IoTOS。

### 1.3、配套书本目录分析

(1)全书共12章，预计250-300页。视频课程与图书配套讲解。

(2)各章标题如下：

   1.快速理解什么是物联网

   2.从技术实现看物联网

   3.华为物联网解决方案一览

   4.什么是操作系统

   5.什么是物联网操作系统

   6.LiteOS软件框架详解

   7.LiteOS内核源码精读

   8.LiteOS SDK外围组件源码精读

   9.本课程使用的硬件平台介绍

   10.LiteOS在NB476开发板上的移植

   11.基于LiteOS的温湿度和断电报警器项目实战

   12.LiteOS未来的发展方向

 

2.物联网的概念

  见书目1.1.1节

3.物联网的发展历程

  见书目1.1.2节

4.物联网的典型案例

  见书目1.2节

5.物联网的分支应用领域

  见书目1.3节

6.究竟该如何理解物联网

  见书目1.4节

7.物联网的技术实现架构

  见书目2.1和2.2

8.物联网各层次涉及的核心技术1

9.物联网各层次涉及的核心技术2

  见书目2.3

10.华为的物联网解决方案介绍

  见书目3.1-3.3

11.华为认证和NBIOT芯片介绍

  见书目3.4-3.5

12.一节课说清楚什么是操作系统

  见书目4.1-4.2

13.操作系统的技术组成和哲学原理

  见书目4.3-4.4

14.如何定义物联网操作系统IoTOS

  见书目5.1-5.2

15.主流IoTOS介绍和LiteOS的优势分析

  见书目5.3-5.4

16.LiteOS的版权约定和开发方式

  见书目6.1-6.4

17.IoTStudio安装和开发方式介绍

  见书目6.5

18.iotlink SDK框架介绍

  见书目6.6

19.iot_link sdk主体介绍

  见书目6.7

20.IoTStudio的基本使用和设置1

  见书目6.8.1

21.IoTStudio的基本使用和设置2

  见书目6.8.1

22.IoTStudio工程的SDK配置原理详解

  见书目6.8.2

23.BSP中项目配置和管理文件1

  见书目6.10.1

24.BSP中项目配置和管理文件2 

  见书目6.10.1

25.BSP中其他文件夹介绍

  见书目6.10.2

26.全栈式LiteOS开发总结

  见书目6.11

27.LiteOS内核源码分析工程建立 

  见书目7.1

28.LiteOS内核OSAL部分源码解析

  见书目7.2

29.LiteOS内核学习方法和基本概念

  见书目7.3和7.4

30.LiteOS的任务管理模块

  见书目7.5

31.LiteOS的任务管理相关源码

  见书目7.6

32.系统时间systick1

  见书目7.7.1

33.系统时间systick2

  见书目7.7.2

34.LiteOS内核的软件定时器

  见书目7.8

35.LiteOS内核的tickless机制1

  见书目7.9

36.LiteOS内核的tickless机制2

  见书目7.9

37.CMSIS-RTOS对接与实现

  见书目7.10

38.LiteOS中和MCU移植对接的部分

  见书目7.11

39.LiteOS的IPC和内存管理模块简介

  见书目7.12

40.LiteOS外围组件整体介绍1

  见书目8.1

41.LiteOS外围组件整体介绍2

  见书目8.1 

42.iot-link的shell组件详解1

  见书目8.2

43.iot-link的shell组件详解2

  见书目8.2

44.iot-link的shell组件详解3

  见书目8.2

45.iot-link的driver框架讲解

  见书目8.3.1

46.driver框架案例之atdev

  见书目8.3.2

47.iot-link的AT框架1

  见书目8.4

48.iot-link的AT框架2

  见书目8.4

49.iot-link的AT框架3 

  见书目8.4

50.iot-link的AT框架4 

  见书目8.4 

51.iot-link的AT框架5 

  见书目8.4 

52.iot-link的华为云oc对接模块解析1

  见书目8.5

53.iot-link的华为云oc对接模块解析2

  见书目8.5

54.iot-link的华为云oc对接模块解析3

  见书目8.5

 

  

  

\---------------------------------------------------------------

以下是书目：

\---------------------------------------------------------------

 

# 1.快速理解什么是物联网

## 1.1.物联网的概念和发展历程

### 1.1.1、认识物联网

(1)百度百科中物联网定义

(2)维基百科中物联网定义

(3)物联网定义总结

  <1> 物联网是互联网是延伸，而不是取代品，所以物联网不必颠覆互联网

  <2> 物联网注重“人与物”、“物与物”之间的连接，而互联网只是“人与人”之间的连接

  <3> 连接是物联网的基础设施，基于连接之上的业务和应用才是物联网的价值

  <4> 物联网是融合性学科，而非单一性学科

### 1.1.2、物联网的发展历程

(1)1990年施乐公司可乐贩售机

(2)1991年MIT首次提出物联网概念，1999年美国麻省理工学院建立了“自动识别中心（Auto-ID）”，提出“万物皆可通过网络互联”，阐明了物联网的基本含义。早期的物联网是依托射频识别（RFID）技术的物流网络。

(3)2005年11.17，ITU重新定义物联网的概念，覆盖范围有了较大的拓展，不再只是指基于RFID技术的物联网。

(4)2009.8，温家宝总理提出“感知中国”，在无锡设立物联网研究院

(5)2015.5，李克强总理签署并发布《中国制造2025》强国战略

(6)物联网的发展历程总结

  <1> 物联网由来已久，是逐步衍生发展而来的，其实任何主流科技都是这样。

  <2> 物联网已经经历泡沫期和幻灭期，本次萌芽发展正在高速拓展中。

  <3> 物联网是重要战略，国内华为、阿里、三大运营商等都投入巨资和重磅计划。

  <4> 得益于良好的互联网产业和电子设备研发制造产业基础，中国发展物联网有天然优势。

## 1.2.物联网的典型案例

### 1.2.1、共享单车

（1）场景分析：解决了随时随地低成本有偿租借自行车的问题。

（2）工作原理和过程：参考素材中图片“共享单车智能锁.jpg”

（3）典型的“人与物”通信，手机app是人的延伸，共享单车智能锁是物的代表。

（4）连接的物理通道是2G网络和蓝牙。

（5）基于连接提供的借车还车、按时长计费的商业模式是业务和应用。

（6）由此拓展的共享充电宝、扫码支付零售机、扫码支付抓娃娃机等均为此类物联网应用。

### 1.2.2、断电监测报警器

（1）场景分析：解决了低成本故障判断问题，极大降低了运维成本。

（2）工作原理和过程：持续监测断电事件并单向报警。

（3）典型的“传感器型”物联网应用，通信以单向上报为主。

（4）为提高部署便利性和降低运维成本，大多数类似产品需要电池供电，因此要求低功耗。

### 1.2.3、智慧城市共享停车系统

（1）场景分析：为解决城市停车位不足，提升停车位资产资源利用率。

（2）工作原理：结合传感器和出入场识别收费系统，动态管控停车位使用和停车费支付。

（3）属智慧城市的一个分支，充分体现物联网在未来智慧城市建设中的重要性。

（4）挑战一方面在于系统成本控制、产品迭代，另一方面在于落地过程的协调和具体问题。

### 1.2.4、案例总结

（1）以上案例只是物联网很小一部分应用，实际还有非常多各种场景的应用详见1.3部分。

（2）谈物联网必须指定具体场景，传感器和连接方案、应用开发都由场景决定。

## 1.3.物联网的分支应用领域

### 1.3.1、智慧城市

（1）智慧交通

   红绿灯的管控, 不能按照找高峰自动调整红绿灯的实践长短

（2）智慧安防

   摄像头和门禁

（3）智慧建筑

   设计建设的时候就考虑了很多物联的设计概念, 比如智能家居所需要的一些必要设施。

### 1.3.2、智能家居

（1）智慧酒店、商场、展厅、场馆等

（2）智慧办公和智慧大楼

（3）智慧家庭

### 1.3.3、智慧医疗

（1）输液监控系统

（2）监测报警手环

### 1.3.4、智慧物流

### 1.3.5、智慧农业

### 1.3.6、智能制造与产业互联网

### 1.3.7、智慧零售

（1）快递柜

（2）无人零售终端

（3）物流配送机器人

## 1.4、总结：究竟该如何理解物联网

（1）物联网是互联网的拓展，将连接对象从人拓展到物。

（2）物联网的核心是基于连接的应用，连接是通道、应用是目的。

（3）物联网具有+的属性，物联网本身只是一些技术的打包，物联网和传统行业的+才是关键。

（4）物联网会产生巨额经济效益，催生多个万亿级市场，是未来10年最重要的技术变革。

 

# 2.从技术实现看物联网

## 2.1、物联网的云管端模型

（1）早期物联网是小型简单化，本地化，离散化非标准的。

（2）现代物联网事实上的标准架构：云-管-端

（3）云指物联网云平台，负责设备接入和管理，部署应用。

（4）管指通信管道，是抽象概念，对应各种有线无线网络通信技术。

（5）端指物联网设备端，也就是嵌入到“物”中的功能核心，一般包括MCU、电源、传感器等。

## 2.2、物联网的典型4层架构

![img](file:///C:/Users/ADMINI~1/AppData/Local/Temp/msohtmlclip1/01/clip_image002.jpg)

  见素材图：物联网4层架构展示.png

## 2.3、物联网各层次涉及的核心技术

### 2.3.1、传感层

（1）物联网设备端，如温度监控器、摄像头、车载智能终端、智慧屏（电视机）等。

（2）核心技术1：MCU及其编程技术

（3）核心技术2：传感器

（4）核心技术3：电池及低功耗技术

（5）核心技术4：通信模组（蓝牙、wifi、2345G、LoRa等）

（6）核心技术5：物联网操作系统及其生态（如模组对接、协议栈等）

### 2.3.2、网络层

（1）为物联网系统提供通信管道的基础设施和软硬件、运维服务等的综合体。

（2）由多段构成而不是单一体。

（3）有多种实现架构，如蜂窝网络、网关式网络、组网式网络、NB-IoT等。

（4）关注参数：通信距离、稳定性、延迟、带宽和速度、建设成本和运维成本等。

（5）一部分是现有成熟技术，一部分是专为IoT设计和建设。

### 2.3.3、平台层

（1）物联网云平台，典型如华为云IoT、阿里云IoT、腾讯云IoT等，是专用于物联网的云平台。

（2）提供设备接入、管理、安全、数据、AI能力等普遍性的物联网常用功能。

（3）提供应用开发和部署能力，可直接承载用户应用。

（4）提供对接能力，可对接外部应用，也可对接第三方服务能力。

### 2.3.4、应用层

（1）应用就是直接面向客户需求，解决客户问题，向客户提供服务的东西的打包。

（2）应用一般包括：服务端后台、前端前台、手机客户端、专用设备客户端等。

（3）不同行业不同应用差异很大，同行业不同客户也会有不同需求。

（4）应用是物联网的直接价值产生地，是物联网项目的总纲领。

 

# 3.华为物联网解决方案一览

## 3.1.华为云IoT

（1）华为云官网：https://www.huaweicloud.com

（2）华为云IoT主页：

https://www.huaweicloud.com/product/IoTCollect.html

（3）当前4大块：IoT联接服务、IoT数据分析服务、IoT行业使能服务、IoT安全服务

## 3.2.华为物联网操作系统LiteOS

（1）华为云官网LiteOS入口：

https://www.huaweicloud.com/product/liteos.html

（2）LiteOS官网：

https://www.huawei.com/minisite/liteos/cn/index.html

（3）LiteOS论坛：https://bbs.huaweicloud.com/forum/forum-729-1.html

## 3.3.IoT Studio及IoT_LINK SDK

（1）IoT Studio是华为专为IoT开发工程师设计的一站式IoT开发IDE

（2）IoT_LINK SDK是LiteOS的全栈式组织，可配合IoT Studio工作，是演进方向。

（3）未来的发展方向：图形化、组件化、松耦合、全栈式

（4）IoT Studio当前下载入口：

https://developer.huaweicloud.com/resource/iot.html

## 3.4.华为物联网认证

（1）什么是华为认证

（2）官网：https://e.huawei.com/cn/talent/#/admin/certifi

（3）华为认证IoT类目

## 3.5.NBIOT芯片

（1）什么是NBIOT，窄带物联网，本质是一种通信技术，类似于2G、3G、4G

（2）NBIOT和5G的关系：NBIOT属于5G mMTC应用的事实标准，是5G大连接业务的一种实现。

（3）NBIOT特点：超低功耗、超大连接、超低成本、超强覆盖

（4）NBIOT应用：传感器类如烟感探头、路边停车、三表等，控制类如智慧路灯

（5）NBIOT现状：2018年开始发展，目前中国三大运营商均已建网，产品落地发展中。

（6）2G会逐步退网，部分被NBIOT替代，部分被4G替代。

（7）华为直接提供：NBIOT芯片

 

4.什么是操作系统

4.1.从公司发展的案例说起

（1）初创期一个人，主要是干活，直接产出价值。不需要管理。

（2）发展期10个人，一起干活，当面沟通，稍有组织即可，不需要专业化管理。

（3）规模期几百几千几万人，部分人纯干活，部分人干活加管理，部分人纯管理。

（4）总结：任何组织和系统的演变发展方向都是组织整体效率最优化配置。

（5）干活、沟通、管理必须模块化划分，然后再有效结合，被证明是最有效的方式。

4.2.为什么要用操作系统

4.2.1、从裸机到操作系统是必然发展路线

（1）发展阶段1：裸机并且全部代码自写

（2）发展阶段2：裸机但调用库函数

（3）发展阶段3：裸机加状态机实现简单的多任务

（4）发展阶段4：上简单操作系统：RTOS（ucos、LiteoS）

（5）发展阶段5：上复杂操作系统：Linux、Windows、Android

4.2.2、用操作系统的优势

（1）轻松实现多任务

（2）轻松借用很多第三方组件功能

（3）更好实现可移植性

（4）减少项目开发复杂度（类比汽车自动挡和手动挡）

（5）代价就是操作系统自身的开销（启动时间、资源消耗、学习投入）

4.3.操作系统的构成

4.3.1.操作系统的核心组件

（1）任务创建和管理调度系统

（2）内存管理（计算机系统的2大核心资源：CPU算力资源、内存资源）

（3）任务间通信机制（沟通、协作）

4.3.2操作系统的外围组件

（1）HAL和硬件驱动

（2）网络通信和协议栈

（3）文件系统

（4）GUI系统

（5）其他第三方组件

4.4.总结：究竟什么是操作系统

（1）操作系统本身是一套软件系统

（2）操作系统负责内部管理而非外部业务

（3）操作系统的本质是代码复用和功能复用

（4）基于操作系统来设计项目是一种思路和技术观

（5）操作系统自身的设计是一门学问

（6）学习操作系统的直接目的：使用操作系统来做项目做产品

（7）学习操作系统源码的目的：更好的使用操作系统，改造甚至自己写新的操作系统

 

5.什么是物联网操作系统

5.1.传统两大类操作系统

5.1.1、RTOS

（1）RTOS的定义和特征：实时性强、不复杂、不庞大、任务数不多

（2）典型RTOS之ucos：单片机全五季课程的第4季

（3）典型RTOS之Vxworks、rtlinux

（4）RTOS的主要应用场景和技术核心：工业、军工、消费电子等

5.1.2、桌面级和服务器级操作系统

（1）基于MMU和虚拟地址映射的OS特征

（2）典型桌面操作系统Windows

（3）典型桌面和服务器级操作系统linux

（4）典型智能手机操作系统Android

（5）基于虚拟地址的操作系统的优势和技术核心

5.2.从RTOS到IoTOS

5.2.1、IoTOS技术上属于RTOS

（1）IoTOS的硬件平台主要是单片机

（2）IoTOS基于实地址而非虚拟地址

5.2.2、IoTOS的本质特征

（1）IoTOS面向物联网设备端场景

（2）比起实时性参数IoTOS更在意周边生态

（3）IoTOS之争核心在于云平台和应用、数据等衍生价值之争，而不是IoTOS本身之争

5.3、市场主流IoTOS介绍

（1）华为LiteOS

（2）RT-Thread

（3）亚马逊freeRTOS

（4）TencentOSTiny

（5）AliOSThings

5.4.华为LiteOS的竞争优势

（1）短小精悍历经实战的kernel

（2）华为的信心背书与强大支撑资源，华为云IoT技术认证体系介绍

（3）丰富的第三方组件支持

（4）华为云IoT的对接匹配

（5）专业IDE工具IoTStudio支持，类似于STM32的cubemx

（6）各种模组厂商和开发生态支持

 

6.LiteOS软件框架详解

6.1.LiteOS官方资源获取

（1）官网：https://www.huawei.com/minisite/liteos/cn/index.html

（2）官方文档

（3）源码获取

（4）IoTStudio及IoT_LINK SDK

6.2.LiteOS的版权说明

（1）产品商免费商用

（2）再发布源码要加声明，再发布二进制要在文档中加声明

（3）不能未经允许随意使用著作权人姓名做背书，不准狐假虎威

6.3.LiteOS的演进历程

（1）独立IoTOS阶段

（2）iot-link SDK全栈式IoTOS阶段1，独立开发的IoTStudio

（3）iot-link SDK全栈式IoTOS阶段2，基于vscode插件的IoTStudio

6.4.LiteOS的两种开发方式

（1）基于Keil等第三方IDE的开发，适合用独立LiteOS，全栈式的反而麻烦

（2）基于IoTStudio和iotlink SDK的开发

6.5.IoTStudio开发方式介绍

（1）官方gitbook：https://flyfishzy.github.io/iotstudio-doc/

（2）安装vscode和iotstudio插件

（3）vscode常用技巧请参考其他教程

（4）注意：iotstudio是IDE、是容器和工具集，而iotlink是SDK、是源码包。2者是分离合作

（5）.vscode目录下是vscode自身的文件和插件，.iotlink目录下是SDK的文件

（6）用户创建项目后，项目文件夹里是该项目专有的文件，项目也会外部引用SDK中的文件

6.6.iotlink SDK框架介绍

6.6.1.IoTStudio为何能图形化管理和编译项目

（1）SDK中settings.json和.ci-build.sh等文件

（2）project中.vscode目录下的json配置文件

（3）iotstudio插件提供的GUI工具和按钮等的配合

（4）未来iotlink跨平台支持主要工作量在iotstudio插件的适配上

6.6.2.sdk的几大组成部分

（1）demos目录，里面是使用sdk完成某些功能的示例代码，可供学习和参考

（2）drivers目录，目前里面只有第三方硬件驱动，只支持ST和GD的MCU库函数

（3）iot-link目录，sdk主体，里面是LiteOS内核和全套外围组件，不断完善增强中

（4）targets目录，目标板管理，里面每个子文件夹都是一个目标板的全套bsp包

（5）Kconfig文件，继承自linux kernel的Kconfig配置体系，结合GUI工具完成配置工作

Makefile和Kconfig等，看《朱有鹏老师嵌入式linux核心课程》

6.7.iot_link sdk主体介绍

指的是这个目录：.iotlink\sdk\IoT_LINK_1.0.0\iot_link

（1）设计思路：模块化设计 + 标准化osal接口

（2）OSAL（os abstract layer）详细介绍，类似于ARM CMSIS，优势是解耦合

（3）各功能模块大概介绍

6.8.IoTStudio的使用

6.8.1.基本使用

（1）项目工程创建和导入

（2）IoTStudio设置1：SDK配置

（3）IoTStudio设置2：SDK管理、工具链设置、编译器和调试器设置

6.8.2.工程的SDK配置原理详解

（1）这一套完全继承于Linux Kernel，向经典致敬

（2）Kconfig文件描述菜单项，配置中是只读的，GUI工具读取Kconfig来生成配置界面框架

（3）.config文件是可读写的，GUI工具读取.config来初始化配置界面中的值

（4）用户的配置会被写入.config中保存，并同时生成autoconf.h，这2者由工具本身保持同步

（5）.config保存配置结果，并参与Makefile工作流程，autoconf.h保留使用

6.9.IoTStudio实战演示和分析

（1）实际操作：基于示例工程创建工程

（2）示例工程文件中各文件从哪来来？起什么作用？

（3）IoTStudio中更改SDK配置，查看.config和autoconf.h中的改变

（4）编译工程并查看编译中提示，和编译后结果

6.10.targets中BSP包结构详解

6.10.1、GCC目录中的项目配置和管理文件

（1）本部分需要的基础：makefile和链接脚本，参考《朱有鹏老师嵌入式linux核心课程》

（2）Makefile

（3）链接脚本

（4）编译后输出目录appbuild

（5）说明1：MDK中开发STM32也用到这些但是在背后，一般不需要开发者自己读和修改这些

（6）说明2：IoTStudio后续应该也会向隐藏后台发展，但是对个人懂这些和不懂是层次差异

6.10.2、其他目录介绍

（1）Demos

（2）OS_CONFIG

（3）Lib

（4）Src和hardware和uart_at

6.11.全栈式LiteOS开发总结

6.11.1、iot-link sdk的移植和使用

（1）硬件平台的移植主要在Targes中，和liteos kernel的arch中

（2）SDK级的配置在iotstudio中，kernel级别的配置在OS_CONFIG中

（3）SDK集成了很多软件模块，用到的配置留下直接用，用不到的配置去掉。

6.11.2、LiteOS开发总结

（1）LiteOS这个名字所代表的东西在不断延伸，不必去纠结名字的改变。

（2）物联网本身在快速发展，相关的开发技术、通信标准、模块、单片机等都在快速发展变化

（3）这种变化对开发者来说很麻烦，但是必须积极应对和适应，不能抵触。

（4）全栈式开发比传统方式开发自由度更小，要花更多去学习和熟悉整套设计

（5）掌握全套设计后的开发工作量实际上是减少的，因此对熟练者整体效率是更高的

（6）套路会不断升级进化，因此结论不重要，方法和思路、学习能力才重要。

 

7.LiteOS内核源码精读

7.1.源码分析工程建立

（1）先用模板创建一个示例工程

（2）添加LiteOS内核源码进去

（3）注意：LiteOS中有一些头文件是.ph和.inc，必须在SI中特别添加这2种否则不识别

（4）添加OS的OSAL部分进去

（5）添加HAL库进去

（6）后续分析时根据需要添加相应的模块进去即可

7.2.OSAL部分源码分析

（1）OSAL部分其实不算LiteOS内核部分，属于独立的连接件

（2）OSAL相关的结构体tag_os和tag_os_ops分析

（3）OSAL在LiteOS中的实现liteos_imp.c分析

（4）LiteOS的OSAL API挨个讲解

（5）基于OSAL编程的正确姿势

7.3.LiteOS内核学习方法

（1）使用内核、基本读懂内核、深度理解内核、自己写内核是不同的4种需求和境界

（2）零基础彻底深度学习OS内核，本来要先学理论，再学实践的。理论主要是看经典书，譬如《深入理解计算机系统》，实践才是找个真实OS分析内核源码，譬如LiteOS内核。

（3）所有的OS实际上差异不大，确实是一通百通的，只是一通比较难。

（4）咱们的讲法是遇到原理简单讲一下，再结合实战源码给对照印证一下。

（5）真的想彻底深入OS kernel，有2大关键：OS理论和C语言功底。

（6）咱们课程分析LiteOS内核跟随LiteOS官方wiki教程的路线。

7.4.LiteOS内核基本概念

7.5.LiteOS的任务管理模块

（1）任务状态和任务切换

（2）任务ID

（3）任务优先级

（4）任务入口函数

（5）任务控制块TCB

（6）任务栈

（7）任务上下文和任务切换

7.6.LiteOS的任务管理相关源码

（1）任务创建于删除

（2）任务状态控制

（3）任务调度的控制

（4）任务优先级的控制

（5）任务信息获取

（6）任务错误码

7.7.系统时间systick

7.7.1、三个时间单位

（1）OS的滴答时钟：systick，OS的节拍

（2）OS的机器时钟：cycle，OS世界中最小计时单元

（3）人类惯用的时间：s/ms/us

（4）人类时间和OS时间的互相换算

7.7.2、OS的systick运行原理

（1）systick周期性产生timeout，进入osTickHandler（los_tick.c中）

（2）handler中对tick计数++，该计数即OS本次开机的“心跳和编年史”

（3）OS中的delay（LOS_TaskDelay，在los_task.c中）就是由systick实现的

（4）timeslice时间片轮转机制也是由systick实现的

（5）swtmr和tickless也是systick引发的，下面2节分别讲。

7.8.LiteOS内核的软件定时器

7.9.LiteOS内核的tickless机制

（1）Tickless实现原理，参考素材中《RTOS低功耗设计原理及实现_TicklessMode(FreeRTOS的实现).pdf》

（2）LiteOS中的tickless实现链条1

  LOS_KernelInit

   osIdleTaskCreate

​     osIdleTask

​      osTicklessHandler

​        osTicklessStart

​          LOS_SysTickStop

​          osSleepTicksGet

​          LOS_SysTickCurrCycleGet

​          LOS_SysTickReload

​        osEnterSleep

（3）LiteOS中的tickless实现链条2

  LOS_KernelInit

   osHwiInit

​     g_pstHwiForm

​      osInterrupt

​        osUpdateKernelTickCount

​          LOS_SysTickReload

​          osTickHandlerLoop

7.10.CMSIS-RTOS对接与实现

（1）CMSIS官网：https://www.arm.com/why-arm/technologies/cmsis

（2）CMSIS优势：标准化接口，方便代码复用

（3）CMSIS由ARM提出并定义接口，ARM提供了内核部分支持，各SoC厂商选择性提供支持

（4）弱势半导体厂商倾向支持，而强势半导体厂商则不倾向支持

（5）LiteOS实现了对CMSIS-RTOS共2个版本的完全移植和支持，源码分析

 

7.11.LiteOS中和MCU移植对接的部分

（1）LiteOS的移植包括三部分；BSP移植、ARCH移植、配置

（2）los_hwi.c中是中断处理相关底层封装

（3）los_hw_tick.c中是systick相关的MCU底层操作封装

（4）los_hw.c中是任务栈初始化和任务调度层封装

（5）los_svc.c和los_syscall.S中是对SVC模式调用LiteOS内核API进行封装

（6）los_dispatch.c中是用汇编开启内核调度的封装

（7）los_hw_exc.S中是汇编处理exception部分的封装

（8）los_startup.S中是汇编启动代码封装

7.12.LiteOS的IPC和内存管理模块简介

7.12.1、LiteOS的IPC

（1）IPC机进程间通信，负责任务之间的通信和同步

（2）IPC的概念和用法在所有OS中几乎完全相同，差异只是具体实现和细节特性

（3）LiteOS的IPC组件有：sem、mux、queue、event

7.12.2、LiteOS的内存管理

（1）MCU裸机开发时用户默认不需要进行内存管理，使用栈和静态区管理内存。

（2）MCU裸机开发也可以使用堆来管理内存，但是要用户自己编程实现，或者环境支撑

（3）LiteOS中内存管理完全自主实现，分为静态管理和动态管理2部分

（4）LiteOS的初级使用不用看本部分，深度使用和优化时再看，需要一定内存管理理论支撑

7.12.3、LiteOS内核部分总结

（1）LiteOS是一个功能完备，实现优质的RTOS内核

（2）建议重点研究OSAL接口使用LiteOS内核

（3）如果是做产品实际并不需要研究内核源码，只需要调用API即可

（4）深度使用LiteOS做产品，或想研究RTOS内核实现，可详细研究LiteOS内核

 

8.LiteOS SDK外围组件源码精读

8.1.LiteOS外围组件整体介绍

8.1.1、简单组件

（1）cJSON

（2）compression_algo

（3）crc

（4）link_log

（5）link_misc

（6）queue

（7）stimer

（8）storage

8.1.2、关联组件

（1）AT

（2）driver

（3）fs

（4）shell

8.1.3、OTA升级相关

（1）loader

（2）ota

（3）upgrade_patch

8.1.4、联网连云

（1）network

（2）oc

（3）usip

8.1.5、OS kernel

（1）os

8.2.iot-link的shell组件介绍

8.2.1、什么是shell

(1)shell就是一套人机交互程序，提供一个cmdline，用户输入命令，然后shell server解析并执行。

(2)shell典型代表：Windows的DOS窗口cmd，uboot

(3)shell包括三个模块：用户输入获取模块，字符串解析匹配模块，命令执行模块

(4)shell本质上是命令应答式设计，很常用，最好掌握

8.2.2、iot-link的shell分析

(1)将shell源码添加到SI工程中，再二次解析符号

(2)shell模块如何被包含进工程，CONFIG_SHELL_ENABLE宏

8.2.3、shell源码分析

(1)shell整个工作流分析，shell_main.c中shell_server_entry函数

(2)shell和串口的关联与对接

(3)shell命令的match和记录，调用执行，shell_cmd.c

(4)shell命令的export和section指定

8.2.4、shell效果演示

(1)help命令

(2)readTemp命令

 

8.3.iot-link的driver框架解析

8.3.1、driver框架

(1)driver是驱动框架，提供驱动注册和管理的方法，不是驱动本身，不管理具体硬件

(2)los_driv_op_t是关键

(3)OSDRIV_EXPORT是驱动框架提供给具体驱动用来实现和注册驱动的接口

(4)OSSHELL_EXPORT_CMD(__driv_show_shell,"devlst","devlst")提供基于shell的driver展示调试信息

(5)总结：驱动框架就是一种通过标准的函数指针接口来调用具体硬件驱动函数的软件框架

8.3.2、uart的atdev详解

(1)uart是一种具体硬件，在liteos中使用串口原则上要先去实现驱动框架下的串口驱动

(2)主要就是实现相应操作函数，然后调用driver框架接口注册

(3)注意硬件中断的注册和isr处理

 

static const os_driv_para_t uart_at_driv __attribute__((used,section("osdriv")))= 

{              

  .name  = "atdev",   

  .op   = &s_at_op,   

  .pri  = NULL,   

  .flag  = O_RDWR,  

}

 

8.4.iot-link的AT框架

8.4.1、AT指令简介

(1)AT指令是典型问答式结构，本质是通信模组底层功能的一套标准shell

(2)AT指令是通信模组惯用事实标准，2345G/WIFI/BT等模组都喜欢封装为AT指令shell给MCU用

(3)AT指令一般都是AT+开头，然后是指令字符串，然后是参数，最后以"\r\n"结尾

(4)AT指令可以去看《朱有鹏老师华为NBIOT物联网课程2018版》第4章

  https://bbs.huaweicloud.com/forum/thread-12969-1-1.html

(5)AT指令的回复一般为OK或Error，再跟具体信息。

(6)BC95模块AT指令演示

8.4.2、LiteOS的AT框架怎么用

(1)at_command函数是关键核心实现

(2)从BC95模组的AT指令处理案例来学习AT框架的使用

(3)总结：什么是AT框架

8.4.3、LiteOS的AT框架源码解析

(1)不需反馈的简单命令发送：__cmd_send

(2)要接收反馈的命令发送：__cmd_create、__cmd_send、__cmd_clear

(3)反馈接收：__rcv_task_entry、__resp_rcv、__cmd_match、__oob_match

(4)at_command主线流程

(5)oob相关

(6)数据结构at_cmd_item和其中关键性的2个sem一个mutex

(7)stream mode和dgram mode

(8)AT框架导出到shell的命令shell_atdebug

atcmd AT+CSQ +CSQ:     通过shell让AT框架执行某个AT指令

atdebug rx/tx none/ascii/hex 通过shell设置AT的调试信息打印情况

 

8.5.iot-link的华为云oc对接模块解析

8.5.1、华为云oc介绍

(1)华为云oc全称oceanconnect，是华为云的其中一个业务模块，面向海量连接的iot业务。

(2)oc处于物联网4层模型的平台层，对下通过网络层对接设备层，对上通过标准restful接口对接应用层

(3)oc与上下层对接都是通过一个IP地址/端口号，和一系列支持的协议和软件接口

(4)oc在南向主要支持mqtt/coap/lwm2m等应用层协议，北向主要是https

8.5.2、iot设备如何对接华为云oc

(1)设备只需能上网，然后使用oc支持的协议，与oc的南向接口ip/port交互即可。

(2)设备端开发难点在于要支持相应的mqtt/coap/lwm2m协议栈，需要一定代码量和编程难度。

(3)设备端协议栈一般有2种实现方法：模组内置协议栈封装为AT指令，MCU软件集成协议栈代码

(4)oc/xx/atiny_xx是MCU集成软件协议栈方式，对应的协议栈在network目录下

(5)oc/xx/bodica1x0_xx是对接NBIOT模组AT指令使用模组内置协议栈，本课程案例使用这种

(6)coap和lwm2m很类似，框架几乎完全一样，本章以lwm2m和bodica150为案例来讲

8.5.3、oc_lwm2m_al分析

(1)lwm2m实现注册：oc_lwm2m_register

(2)三个有用函数：oc_lwm2m_config、oc_lwm2m_deconfig、oc_lwm2m_report

(3)相关数据结构

8.5.4、bodica150_oc分析

(1)用户app中初始化接口：boudica150_init

(2)三个有用函数实现：boudica150_oc_config、boudica150_oc_deconfig、boudica150_oc_report

(3)有用函数实现实体中和AT框架对接部分

8.5.5、atiny_xx的实现简单分析

(1)oc_lwm2m_al仍然是对接中间件，atiny_lwm2m是对接实现实体，network\lwm2m里是lwm2m协议实现实体

(2)oc\oc_lwm2m\oc_lwm2m_al->oc\oc_lwm2m\atiny_lwm2m->network\lwm2m\lwm2m_al->lwm2m具体实现

8.5.6、用户如何使用iot-link的oc对接

(1)做好各组件配置，选定自己的实现中各组件，注意那些宏

(2)用户app的通信task的初始化流程中调用boudica150_init或其他同级函数，注意server配置

(3)本地设备端获取用户要上报的信息（譬如温度、湿度、断电信息、电压、烟雾浓度等）

(4)按照本地上报规则，调用boudica150_oc_report或同级函数完成上报

(5)以上未考虑网络安全和数据加密，若要加密需添加dtls支持，iot-link也有提供对接了

 

 

 

 

9.本课程使用的硬件平台介绍

 

 

10.LiteOS在NB476开发板上的移植

 

 

11.基于LiteOS的温度项目实战

 

12.LiteOS未来的发展方向

12.1.越来越丰富的组件

12.2.越来越好用的IoTStudio

12.3.定制优化的IoT通信协议

12.4.越来越完善的安全和可信组件

 

后记

  主要写本书的总结和不足，未来的更新计划等。

 

 

 

本书的目标是让读者快速掌握华为LiteOS和华为云IoT，在华为物联网体系赋能下更快速更低成本的孵化自身物联网产品。

 

本书主要讲了

 

 

 

 

 

 

 

 

 

 

 

 

 